<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML lang="ja">
<head>
<title>Missing Value</title>
<link rel="stylesheet" type="text/css" href="./rubydcl.css">
</head>

<body>
<h1><a name="missing" id="missing">欠損値の扱い</a></h1>
<p>
2003年3月　西澤 誠也
2004年3月　西澤 誠也
</p>

<hr/>
<p>
欠損値を持ったデータを扱う際 NArrayMiss Class を使うと便利です。
<ul>
 <li><a href="#narraymiss_class">NArraMissクラス</a></li>
 <li><a href="#dcl">DCLでお絵書き</a></li>
 <li><a href="#gphys">GPhys</a></li>
</ul>
</p>

<h2><a name="narraymiss_class" id="narraymiss_class">NArrayMiss クラス</a></h2>
<p>
欠損値を持った NArray の配列を扱う場合
<br/><a href="./missing1.rb">missing1.rb</a><br/>
<textarea cols="80" rows="10" class="source">
require "narray"

ndim = 10
rmiss = -999.0

x = NArray.sfloat(ndim).indgen
x[3] = rmiss
y = NArray.sfloat(ndim).indgen(10)
y[5] = rmiss

z = NArray.sfloat(ndim)
for n in 0..ndim-1
  if x[n]!=rmiss && y[n]!=rmiss then
     z[n] = x[n]+y[n]
  else
     z[n] = rmiss
  end
end
p z
</textarea><br/>
もしくは
<br/><a href="./missing2.rb">missing2.rb</a><br/>
<textarea cols="80" rows="10" class="source">
require "narray"

ndim = 10
rmiss =-999.0

x = NArray.sfloat(ndim).indgen
x[3] = rmiss
y = NArray.sfloat(ndim).indgen(10)
y[5] = rmiss

z = NArray.sfloat(ndim).fill(rmiss)
mask = x.ne(rmiss)&y.ne(rmiss)
z[mask] = x[mask]+y[mask]
p z
</textarea><br/>
となります。
</p>

<p>
ruby ではすべてはオブジェクトであり配列自身に欠損値情報をもたせることが出来ます。<br/>
<a
href="http://www.gfd-dennou.org/arch/ruby/products/narray_miss/index-j.html">
NArrayMiss クラス</a>は NArray の配列とマスクをあわせ持ったものです。
NArrayMiss クラスを利用すると
<br/><a href="./missing3.rb">missing3.rb</a><br/>
<textarea cols="80" rows="10" class="source">
require "narray_miss"

ndim = 10

x = NArrayMiss.sfloat(ndim).indgen!
x.invalidation(3)
y = NArrayMiss.sfloat(ndim).indgen!(10)
y.invalidation(5)

z = x+y
p z
</textarea><br/>
のように、欠損のことを気にすること無く演算ができます。
</p>
<p>
四則演算以外にもいくつかのメソッドが用意されています。
<a href="http://ruby.gfd-dennou.org/products/narray_miss/narray_miss.html">
ドキュメント</a>参照のこと
<table width="80%"><tr><td><pre class="source">
NArrayMiss#%
NArrayMiss#**
NArrayMiss#sum
NArrayMiss#accum
NArrayMiss#min
NArrayMiss#max
NArrayMiss#mean
NArrayMiss#stddev
</pre></td></tr></table>
<a href="./missing4.rb">missing4.rb</a><br/>
<textarea cols="80" rows="10" class="source">
require "narray_miss"

ndim = 10

x = NArrayMiss.sfloat(ndim).indgen!
x.invalidation(3)

for method in ["sum","min","max","mean","stddev"]
  str = 'print "'+method+' = ",x.'+method+',"\n"'
  eval(str)
end
</textarea><br/>
</p>
<p>
NArrayからNArrayMissを作る際は以下のようにします。
<table><tr><td><pre class="source">
NArrayMiss.to_nam(narray,mask)
</pre></td></tr></table>


<h2><a name="dcl" id="dcl">DCLでお絵書き</a></h2>
<p>
DCLでお絵書きする際に欠損値処理を有効にするためには
<table width="80%"><tr><td><pre class="source">
DCL::gllset("lmiss",true)
</pre></td></tr></table>
とします。
</p>
<p>
簡単な例をあげます。
<br/><a href="./missing5.rb">missing5.rb</a><br/>
<textarea cols="80" rows="10" class="source">
require "numru/dcl"
require "narray_miss"

include NumRu

rmiss = -9.99e10

nt = 50
nz = 50
tmin, tmax = 0.0, 5.0
zmin, zmax = 20.0,50.0
t = NArray.sfloat(nt+1,   1).indgen! * (tmax-tmin)/nt
z = NArray.sfloat(   1,nz+1).indgen! * (zmax-zmin)/nz
t[10..12,0] = rmiss
z[0,5..10] = rmiss
t = NArrayMiss.to_nam(t,t.ne(rmiss))
z = NArrayMiss.to_nam(z,z.ne(rmiss))
uz = NMMath::exp(-0.2*z)*(z**0.5)
tz = -2.0*NMMath::exp(-0.1*z)
u = uz*NMMath::sin(3.0*(tz+t))

DCL::gropn(1)
DCL::gllset("lmiss",true)
DCL::grfrm
DCL::grswnd(tmin, tmax, zmin, zmax)
DCL::uspfit
DCL::grstrf
DCL::usdaxs
DCL::udcntr(u)
DCL::grcls
</textarea><br/>
<table width="80%"><tr><td class="results">
<img src="./missing5.png" width="456"/>
</td></tr></table>
</p>



<h2><a name="gphys" id="gphys">NetCDF,GrADSファイルの解析</a></h2>
<p>
NetCDF,GrADSのデータを扱う場合は、
GPhysを使いましょう。
内部でNArrayMissが使われます。
くわしくは GPhys の説明を見てください。
</p>


<hr/>
<a href="./index.html">return</a>

</body>
</html>
