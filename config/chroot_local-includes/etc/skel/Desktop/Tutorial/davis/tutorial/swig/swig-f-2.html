<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"> 
<HTML lang="ja">
 <HEAD>
  <META http-equiv="Content-Type" content="text/html; charset=Shift_JIS">
  <META name="author" content="whitecat">
  <LINK REV=MADE HREF="mailto:kozuka@unyo.marushin.media.kyoto-u.ac.jp">
  <LINK REL="CONTENTS" href="./index.html">
  <LINK rel="stylesheet" href="./css/base.css" type="text/css">
  <LINK rel="stylesheet" href="./css/top.css" type="text/css">
  <TITLE>SWIG:Ruby Programing for FORTRAN</TITLE>
 </HEAD>
 <BODY>
  <DIV class="title">
   <SPAN class="main">Ruby Programing for FORTRAN</SPAN>
   〜SWIGを使う(2)〜
  </DIV>
  <H2>
   内容
  </H2>
  <P>
   SWIGの基本的な使い方を説明するためにCで書かれた以下の関数を拡張ライブラリ化する例を示します。
  </P>
  <BLOCKQUOTE>
   <PRE>
%cat test.c

int add(int a, int b)
{
  return(a + b);
}
   </PRE>
  </BLOCKQUOTE>
  <H2>
   .
  </H2>
  <P>
   今回、このaddという関数をTestというモジュールの関数にラップします。
   次のようなファイルを用意します。名前はtest.iにしておきましょう。
  </P>
  <BLOCKQUOTE>
   <PRE>
%cat test.i
%module test

int add(int a, int b);
   </PRE>
  </BLOCKQUOTE>
  <P>
   一行目で"Test"というモジュールを作るということを宣言します。
   以下、追加する関数を列挙していきます。<BR>
   編集が終わったらこのファイルを利用してモジュール用のソースを生成します。
  </P>
  <BLOCKQUOTE>
   <PRE>
%swig -ruby test.i
%ls -al
total 12
drwxr-xr-x  2 kozuka  staff   512 Jun 28 02:44 .
drwxr-xr-x  4 kozuka  staff   512 Jun 28 02:11 ..
-rw-r--r--  1 kozuka  staff    45 Jun 28 02:12 test.c
-rw-r--r--  1 kozuka  staff    39 Jun 28 02:36 test.i
-rw-r--r--  1 kozuka  staff  7746 Jun 28 02:43 test_wrap.c
   </PRE>
  </BLOCKQUOTE>
  <P>
   test_wrap.c、これが拡張ライブラリのソースになります。<BR>
   後はMakefileを用意してmakeするだけです。
  </P>
  <BLOCKQUOTE>
   <PRE>
%cat Makefile.rb

require 'mkmf'
create_makefile('test')
^C
%ruby Makefile.rb
%make
cc -fPIC -D_THREAD_SAFE -O -pipe  -fPIC -I/usr/local/lib/ruby/1.6/i386-freebsd4.3 
-I/usr/local/include -c -o test_wrap.o test_wrap.c
cc -shared -Wl,-soname,test.so -L/usr/local/lib -o test.so test.o test_wrap.o -L. 
-lruby -lc
   </PRE>
  </BLOCKQUOTE>
  <P>
   ここではMakefile.rbのcreate_makefileで指定した名前の共有オブジェクトを作るMakefileを生成しています。mkmfの使い方の詳細はRuby付属のREADME.EXTをよんでください<BR>
   最後にadd関数のラップができているかテストしてみます。
  </P>
  <BLOCKQUOTE>
   <PRE>
%ruby -e "require 'test.so'; p Test.add(1, 2)"
3
   </PRE>
  </BLOCKQUOTE>
  <P>
   問題なく動いているようです。
  </P>
  <H2>
   .
  </H2>
  <P>
   <A href="swig-1.html" accesskey="b">前に戻る</A>
   <A href="swig-f.html" accesskey="in">[目次]</A>
   <A href="swig-f-3.html" accesskey="f">先に進む</A>
  <DIV class="footer">
   <A href="http://jigsaw.w3.org/css-validator">
    <IMG style="border:0;width:88px;height:31px" src="http://jigsaw.w3.org/css-validator/images/vcss.gif" alt="Valid CSS!">
   </A>
  </DIV>
 </BODY>
</HTML>