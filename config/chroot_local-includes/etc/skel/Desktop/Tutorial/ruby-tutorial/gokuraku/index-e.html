<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head>

<!-- base href="http://ruby.gfd-dennou.org/tutorial/gokuraku/" -->

<meta http-equiv="Content-type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rel="stylesheet" href="dennou-ruby.css" type="text/css">
<title>Dennou-Ruby Tutorial</title>
</head>

<body>
 <a href="http://ruby.gfd-dennou.org/">GFD Dennou Club</a>
/<a href="http://ruby.gfd-dennou.org/index-e.htm">Dennou Ruby</a>
/<a href="http://ruby.gfd-dennou.org/tutorial/inde-e.htm">Tutorial</a>
/Basic course<hr>

<h1> Dennou-Ruby tutorial page (basic course)</h1>


<p> Basic how to use as a scripting language of Ruby is introduced
first here. Data of introduction of a package and a earth science
necessary to the several more calculating value and arrangement
calculation is read and written, and it follows introduction of a
visualized way. Fluid numerical value calculation is being also done at
the last way.</p>

<p>
 <a href="#h2-1">1. Basic how to use Ruby</a><br>
 <a href="#h2-2">2. Arrangement is calculated using NArray.</a><br>
 <a href="#h2-3">3. A picture is drawn in Ruby-DCL.</a><br>
 <a href="#h2-4">4. Reading and writing of a character data</a><br>
 <a href="#h2-5">5. The reading and writing which is data in Ruby-NetCDF</a><br>
 <a href="#h2-6">6. Fluid numerical value calculation.</a><br>
</p>


<a name="h2-1"></a>
<h2>1. Basic how to use Ruby</h2>

<p> Ruby is a scripting language like Perl and a shell script. When the
file in which a script was written is made and Ruby is called, the
contents are carried out. First it's the contents by an editor.</p><pre class="source">
print ("Hello, World\n")
</pre><p> A written file is made and it's preserved by the name as test1.rb. And.</p><pre class="source">
%<span class="command"> ruby test1.rb</span>
</pre><p> When the command is carried out (The % is the character a prompt and blue bold face input actually.)</p><pre class="source">
Hello, World
</pre><p> It's indicated. A script says "A table indicate the part
bound up with "" (= character string).", doesn't it? "\n" shows a new
paragraph.</p>

<p> Japanese can also be used. It's written on the head with #!
/usr/bin/env ruby, in chmod + x, it's possible to carry out, when
doing, I finish in % ./test1.rb.</p><pre class="source">
%<span class="command"> chmod +x test2.rb</span> 
%<span class="command"> cat test2.rb</span> 
#!/usr/bin/env ruby print("hello, the world \n") 

%<span class="command"> ./test2.rb</span> 
Hello, the world
</pre><p> Even if a file isn't edited by an editor, it's possible to carry out by in-line. -e option is used.</p><pre class="source">
%<span class="command"> ruby -e 'print("Hello, World\n")'</span> 
Hello, World
</pre><p> ruby of an interactive as irb is also prepared. irb (main): A
prompt such as 001:0&gt; shows, so when a script is described there, a
result will be indicated immediately.</p><pre class="source">
 %<span class="command"> irb</span> 
 irb(main):001:0&gt; <span class="command"> print("Hello, World\n")</span> 
 Hello, World  # standard output
 nil # A return value is also indicated in irb
 irb(main):002:0&gt; <span class="command"> exit</span> 
 %
</pre><p>

</p><div class="note"><p> There is also something as irbsh as the execution environment on emacs (Special installation is needed and refer to the <a href="http://www.rubyist.net/%7Erubikitch/computer/irbsh/">http://www.rubyist.net/~rubikitch/computer/irbsh/</a> vicinity.)</p><pre class="source">
irbsh[16:19](main):001:0&gt;print ("Hello, World\n") #irb if you start form line head
Hello, World
nil #also indicates a return value in standard output
&lt;
[pwd:~]
irbsh[16:19](main):002:0&gt;
irbsh[16:20](*SHELL*):003:0&gt; ls # SHELL if you start with a space 
~ $ ls
Choices Desktop Mail bin doc lib rpm tmp
DATA GNUstep Xrootenv.0 dennou install public_html src work
</pre><p>

</p></div><p> Basic how to use ruby will be seen using irb at below.</p>


<p> The type declaration is unnecessary for Ruby.</p><pre class="source">
%<span class="command"> irb.</span> 
irb(main):001:0&gt;<span class="command"> a = 2</span>        # Integer 
=&gt; 2
irb(main):002:0&gt;<span class="command"> b = 3.5</span>      # The real number
=&gt; 3.5
irb(main):003:0&gt;<span class="command"> c = "apple"</span>  # String
=&gt; "apple"
</pre><p> " Even if a blank on both sides of the =" is put in, you
don't need to put it in. An integer as 2, the real number as 3.5 and a
character string as "apple" are possible to think these to have
substituted for a variable as a, b, c, a name tag as a, b, c was put on
the integer object as 2, the real number object as 3.5 and the
character string object as "apple" actually, said, equivalent.</p><p> An object also has its style and size as well as price in various information by itself.</p><pre class="source">
irb(main):004:0&gt;<span class="command"> a</span>           # value of the object
=&gt; 2
irb(main)005:0&gt;<span class="command"> b.class</span>     # class of the object 
=&gt; Float
irb(main)006:0&gt;<span class="command"> c.size</span>      # size of the object
=&gt; 5
irb(main)007:0&gt;<span class="command"> 3.5.class</span>   # same as b.class
=&gt; Float
</pre><p> Upper class and size are called the method. To an object, "Of
the type, it's stating." "Of the size, it's a response.", etc. and a
message will be sent. An object "is the real number" to that, "It's
5.", you answer etc..</p><p> Calculation will be also done of course. Please try it variously.</p><pre class="source">
irb(main):008:0&gt;<span class="command"> d = a * (b**2 + 3.0e2)</span> 
=&gt; 624.5
irb(main):009:0&gt;<span class="command"> e = c + "orange"</span> 
=&gt; "appleorange" # as addition of a character string is just lined up in turn.
</pre><p>

</p><div class="note"><p> By the way, it's possible to operate more than one variable at once.</p><pre class="source">
irb(main):010:0&gt;<span class="command"> e,f = a*b, e+"lemon"</span> 
=&gt; [7.0, "appleorangelemon"]
</pre><p> When it's begun by a capital letter, it'll be the fixed number. When I try to rewrite the fixed number, a warning is issued.</p><pre class="source">
irb(main):011:0&gt;<span class="command"> A = 3.1415927</span> 
=&gt; 3.1415927
irb(main):012:0&gt;<span class="command"> A = 1.7320508</span> 
(irb) :22: warning: already initialized constant A
=&gt; 1.7320508
</pre><p> ' The part bound up with-' will be also a character string,
but here also deals with a control character as the character just as
it is.</p><pre class="source">
irb (main): 013:0&gt;<span class="command"> print 'apple\n'</span> 
apple\n=&gt; nil # Without changing line, \n was shown
</pre></div><p> A style change uses the method such as to_s, to_i, to_f.</p><pre class="source">
irb(main):101:0&gt;<span class="command"> g = b.to_s</span> 
=&gt;"3.5" # to_s  convert to string
irb(main):102:0&gt;<span class="command"> h = b.to_i</span> 
=&gt; 3 # to_i convert to integer
irb(main):103:0&gt;<span class="command"> a.to_f/3 - a/3</span> 
=&gt; 0.666666666666667 # to_f convert to real
</pre><p> An object is lined in turn, and, [ ], Eaten one is arrangement. It isn't necessary to be the same style in the arrangement.</p><pre class="source">
irb(main):113:0&gt;<span class="command"> ary1 = [3, b, d-3.0, "orange"]</span> 
=&gt; [3, 3.5, 621.5, "orange"]
irb(main):114:0&gt;<span class="command"> ary1[0]</span> 
=&gt; 3 # C and the factor which is the beginning similarly 0th
irb(main):115:0&gt;<span class="command"> ary1[1..3]</span> 
=&gt; [3.5, 621.5, "orange"] # from number 1 of to number 3
irb(main):116:0&gt;<span class="command"> ary1[-1]</span> 
=&gt; "orange" # which counts the number of the negative from the rear
irb(main)117:0&gt;<span class="command"> ary2 = [a, ary1]</span> 
=&gt; [ [2, 3, 3.5, 621.5, "orange"]] # it's all right for arrangement to be in the arrangement. 
irb(main):118:0&gt;<span class="command"> ary2 [1][3]</span> 
=&gt; "orange" # the 3rd element of ary2[1]
</pre><p> for, if, while, case can be used for control of a flow of a program. It can be used of course even in irb.</p><pre class="source">
irb(main):121:0&gt;<span class="command"> for i in 1..5</span> 
irb(main):122:1&gt;<span class="command">   print(i,"\n")</span> 
irb(main):123:1&gt;<span class="command"> end</span>
</pre><p> The left number of "&gt;" of a prompt shows the depth of the nest, and no nests are performed to 3 line eye which disappears.</p><pre class="source">
irb(main):131:0&gt;<span class="command"> if (a==3) then</span>     # where you may have no then
irb(main):132:1*<span class="command"> print "Hello\n"</span>    # The in case of which isn't ambiguous omits a parenthesis, possible
irb(main):133:1&gt;<span class="command"> else</span> 
irb(main):134:1*<span class="command"> print a,"\n" if a != 4</span>    # The addition is also possible by if sentence,
irb(main):135:1&gt;<span class="command"> end</span>
</pre><p> There is also something as ITERETA to process in turn to each element of arrangement.</p><pre class="source">
["dog","cat","bird"].each {|i|
  printf ("a %s\n",i)
}
</pre><p> each {...} The method which takes (or, do ... end) for an
argument. Each element of arrangement. |. It's stocked in a variable
in| (here, i) and operation to the i is described. There is something a
variety in ITERETA, and a loop can be described more directly. It's
often more convenient than for is used.</p><pre class="source">
(1..10).each{|i|
  printf ("%02d\n",i)
} 

10.times do #  10 times Repeat 
  print "hoge"
end 

loop do # infinite loop
  break if STDIN.gets=="\n"
end # which passes through a loop when inputting a blank
line 

loop do
  break if /^$/ =~ gets # the same as the above (/.../ is a regular expression)
end

</pre><p>

</p><div class="note"><p> Note: ITERETA (block) makes scope of a variable (the effective area). The following script will be an error.</p><pre class="source">
(1..10) .each{|i|
 b = i
} 

b doesn't exist outside the b # {...}, so it'll be an error.
</pre><p> To avoid an error.</p><pre class="source">
b = 0 
(1..10) .each{|i|
 b = i
} 
b # 10
</pre><p> Be so, it's done.</p></div><p> A mathematical function uses a Math module.</p><pre class="source">
a = Math::cos(0) # The function cos of Math module
p = Math::PI
</pre><p> When include sentence is used, a part of "Math::" becomes unnecessary in after a while.</p><pre class="source">
include Math
a = cos(PI)
</pre><p> def is used to define the method.</p><pre class="source">
def add(a,b,c)
  d = a+b+c
  return d # Designation of return value
end
e = add(3,4,6)
</pre><p> All objects belong to some classes.<br> Procedure to an
object (the method) shows the kind of objects with a class, and is
defined every class. For example "3.5" is an object in a class as
Float, in the Float class, +, -, *. /The method such as (arithmetic
operation) and abs, floor, to_i, to_s is defined. A module is the group
which gathered the function of the method and the fixed number, and
inclusion is done and it's used as the need arises.</p>

<p> The function will be expanded using a NArray class and something
such as DCL modules and NetCDF ranges at a point from here. The way to
make a class by oneself is introduced after it.</p>



<a name="h2-2"></a>
<h2> 2. Arrangement is calculated using NArray.</h2>

<p> Arrangement equipped with standards in Ruby (Array) lined an object
up in turn, and this is also 1 object. It isn't necessary to be the
same style and an element of arrangement is the flexible one in which
an optional object can be stocked as it matched an upper example, so
its part calculation rate is sacrifice. So when we do numerical value
calculation, a class package as NArray will be used.</p>
<p> It's written on a <a href="http://www.ir.isas.ac.jp/%257Emasa/ruby/na/SPEC.ja">NArray method list</a> about the method of NArray, so please refer to it suitably.</p>

<h3> How to make</h3>

<p> To use a NArray class, first.</p><pre class="source">
require "narray"
</pre><p> It's done. A definition in a NArray class is read with this.
Arrangement is generated newly (An object in a NArray class is
generated newly it means that.), for, it's made NArray.new (" The
type", the size and bigness...) But NArray where the usual is easier
than that. The style (The size and bigness...) is used. For example to
make single precision real number arrangement ary1 of 3x4.</p><pre class="source">
ary1 = NArray.sfloat(3,4)
</pre><p> It's so. The price of the contents is all 0 only with this.
Next I make the method which sets the contents act on this arrangement
object.</p><pre class="source">
ary2 = NArray.sfloat(6).fill!(3.0) # By arrangement of length 6, the contents are all 3.0
ary3 = NArray.sfloat(10).indgen! # set value incremented with 1
</pre><p> To change from usual arrangement (Array) to NArray.</p><pre class="source">
ary4 = [2 or 3 or 4.5 or 8] # ordinal ruby array
 ary5 = NArray.to_na(ary4)  # convert ary4 to NArray.
</pre><p> It's done. When the real number is also included in the
inside by 1, for example all elements will be arrangement of the real
number in NArray, and is the real number.</p>

<h3> Index</h3>

<p> The first element number is 0 similarly, and the last element
number is the number of elements - 1 with Array and a C language for an
index. The order of the multidimensional index is same as Fortran, and
a number is increased from the previous element.</p><pre class="source">
ary6 = NArray.sfloat(4,3).indgen!(1.02.0) # The value which increased 2 from 1 is set. 
ary6[0,0]  # the first element
ary6[1,0]  # next element
ary6[1..2,0..-1] # slice part of the ary
ary6[true,1]  # true is the same as 0..-1
ary6[0..1,0] = 999
ary6
</pre><p>

</p>

<h3> Calculation</h3>

<p> You calculate every element.</p><pre class="source">
ary7 = NArray.sfloat(43).fill!(3.0)
ary6 + ary7
ary6 * ary7
ary6 %  ary7
ary7 - 1.5
ary6 ** 2
</pre><p>

</p>

<h3> Practice problem</h3>

<p> A score of a test in 20 classes in Mr. 笑介 is science.<br> 65 80 67 35 58 60 72 75 68 92 36 50 2 58.5 46 42 78 62 84 70<br> English.<br> 44 87 100 63 52 60 58 73 55 86 29 56 89 23 65 84 64 27 86 84<br>
It was so. I ask an average mark, a standard deviation and the
deviation value about according to the subject and a total and score
high points, rearrange it in turn.</p>


<a name="h2-3"></a>
<h2> 3. A picture is drawn in Ruby-DCL.</h2>

<p> On the presumption that DCL (Fortran edition) has been used, this
clause is doing. When having not used it, the one acquired from
visualization using GPhys (GGraph or GAVE) may be easy to understand
about visualization. When advancing in a <a href="http://ruby.gfd-dennou.org/products/gphys/tutorial/">GPhys
tutorial</a> when having knowledge to here in the class where the grid
point data which is handled by the data form by which GPhys is
NetCDF,GrADS,grib is treated, it's possible to do an analysis of data
and visualization of such form. But, GGraph and GAVE use Ruby - DCL
inside, and just as I'll establish it small, I still need knowledge of
Ruby - DCL. Please read <a href="http://ruby.gfd-dennou.org/products/ruby-dcl/ruby-dcl-doc/gokuraku/index.htm">easy DCL</a>very much to acquire from one about Ruby-DCL</p>


<p>I'll draw a figure using Ruby - DCL first.</p><pre class="source">
require "numru/dcl"
</pre><p>When O increases, it's possible to use an after DCL module. A subroutine of DCL.</p><pre class="source">
NumRu::DCL::gropn(1)
</pre><p>When writing it, how does NA move like DCL of Fortran edition? But, at this rate it's long, so usually, NumRu, include.</p><pre class="source">
include NumRuDCL::gropn(1)
DCL::grfrmDCL::sgtxr (0.5,0.5,"abc")
DCL::grcls
</pre><p>
After a while will write a script and use the ruby command. NArray of
single precision real number (sfloat) is given to arrangement.</p>

<h3>Polygonal line figure</h3>

<p>Example<a href="hop.rb">: hop.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
# hop.rb
require "narray"
require "numru/dcl"

include NumRu
include NMath #  Math module of NArray

nmax = 400
dt = 2*PI/(nmax-1)
t = NArray.sfloat(nmax).indgen! * dt # t is a parameter (0&lt;=, t&lt;2 pi)
x = 1e2 *sin(4*t)
y = 1e-3*cos (5*t)+ 6

p x
DCL::gropn(1) 
DCL::grfrm 
DCL::ussttl('X-TITLE', 'x-unit', 'Y-TITLE', 'y-unit') 
DCL::usgrph(x, y) 
DCL::grcls
</textarea>

<p> "#" The back is ignored by a comment more. The command as p (It
outputs by the shape that the contents of an object are easy to read
for man.) is used for the occasion using the script.</p><p> After an upper file is downloaded.</p><pre class="source">
 %<span class="command"> ruby hop.rb</span>
</pre><p> It'll be so and is as follows.</p><p class="results">
<img src="hop.png" height="341" width="456">
</p>

<p> It isn't necessary to give it and the argument to which the length
of the arrangement is handed is compared with DCL in 77th edition of
Fortran. (Example : CALL USGRPH (N,X,Y) -&gt; DCL::usgrph (x,y))</p><pre class="source">
include DCL
</pre><p> When writing it, it's possible to omit a part of after DCL::.</p>


<h3> Contour line and applying reason figure</h3>




<p> Example <a href="contour.rb">: contour.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
# require "narray" # In the "numru/dcl", narray is required, so it is unnecessary actually
require "numru/dcl"
include NumRu
include NMath

nt = 50
nz = 50
tmin, tmax = 0.0, 5.0
zmin, zmax = 20.0,50.0
t = NArray.sfloat(nt+1,1).indgen! * (tmax-tmin)/nt # transverse (nt+1,1) arrangement
z = NArray.sfloat(1,nz+1).indgen! * (zmax-zmin)/nz # vertical axis (1,nz+1) arrangement

uz = exp(-0.2*z) * (z**0.5)
tz = -2.0*exp(-0.1*z)
u = uz*sin(3.0* (tz + t)) # It'll be arrangement of (nt+1,nz+1).

=begin
 if command line has -ps option, create PS file (gropn(2)),
 if not, open window (gropn(1))
=end
if ARGV.index ("-ps")
  DCL::gropn(2)
else
  DCL::gropn(1)
end

DCL::grfrm
DCL::grswnd(tmin, tmax, zmin, zmax)
DCL::uspfit
DCL::grstrf # coordinate

DCL::sglset('lfprop',true) # proportional font
DCL::ussttl('TIME', 'YEAR','HEIGHT', 'km') # setting title
DCL::uelset("ltone",true) if ARGV.index("-color")
DCL::uetone(u) if ARGV.index ("-color")
DCL::usdaxs # draw axis
DCL::udcntr (u) # draw contour lines

DCL::sgstxs(0.02) # set size of charactor
DCL::sgtxr(0.7,0.9, "umin="+u.min.to_s+" umax="+u.max.to_s) # to_2: convert to string

require "date"  # require can be middle of your ruby code
DCL::sgtxr(0.75,0.85, "created by # {$0} # {Date.today}")

DCL::grcls
</textarea>

<p> A part from "=begin" in a line head to "=end" will be also a
comment. 21 lines of command line option is being checked by an eye and
34 line eye. ARGV is arrangement of a command line option.</p><pre class="source">
 % ruby contour.rb -color
</pre><p> When doing, a figure with the color like the bottom will be
done. The numerical value is changed to a character string in to_s by
40 line eye, and it's outputting in a screen. Today's date also
indicates that 42 lines of "date" class is used like an eye. # {...}
also changes a result to a character string.</p>

<p class="results">
<img src="contour.png" height="341" width="456">
</p>

<h3> Practice problem</h3>

<p> Make a graph of the frequency distribution of the score about a test result of the class in Mr. 笑介.</p>
<p> Rewrite a DCL drawing Fortran program of holdings in Ruby (When you can cry, a sample is rewritten.)</p>

<a name="h2-4"></a>
<h2> 4. Reading and writing of a character data</h2>

<p> Ruby is a scripting language conscious of Perl, and the function of
the string manipulation is strong. Using that, I'll read and write the
data written on a text file.</p>

<h3> A character data is read and a figure is drawn.</h3>

<p> 1 radiosonde archive<a href="http://www.ncdc.noaa.gov/oa/cab/igra/"> http://www.ncdc.noaa.gov/oa/cab/igra/</a>
empty spot in NOAA is chosen as an example and radiosonde observational
data is acquired. " When a link of ASCII Files" is being followed, a
text file (the one made hard in zip) can be acquired. Tateno's (=
Tsukuba) recent data is put <a href="47646.y2d">here</a> temporarily.</p>

<p> When the contents of the text file will be seen first.</p><pre class="source">
 %<span class="command"> more 47646.y2d</span> 
# 4764620040101002330 67
21101100B 31 58B 59 250 10
10100000 123B 66B 90 0 0
20 98600 -9999 64B 100-9999-9999
30 95200 -9999 -9999 -9999 120 30
10 92500 759B 24B 80 210 20
30 91300 -9999 -9999 -9999 250 20
30 90000 -9999 -9999 -9999 260 51
30 87500 -9999 -9999 -999 285 108
10 85000 1435B -25B 80 280 118

  : 

20 770 -9999 -437A-9999-9999-9999 
# 4764620040101069999 25
31101100B 31 -9999 -9999 140 15
30 93200 -9999 -9999 -9999 135 20 

  :

</pre><p> It is. To read this file in Ruby.</p><pre class="source">
file1 = File.open("47646.y2d","r")
</pre><p> It's done. file1 will be an object in a File class which
corresponds to this file (for "r", read only). To read 1 line from
file1.</p><pre class="source">
file1.gets
</pre><p> It's done. When gets is repeated, the line of the following is continued and read. To return to the head of the file.</p><pre class="source">
file1.rewind
</pre><p> It's done. When <a href="http://www1.ncdc.noaa.gov/pub/data/igra/readme.txt">readme.txt</a>
is seen, data of the style and the temperature seems to include the
line with the "#" in the line besides the header and that in a line
head. So if the read line is header, a date is read and page feed is
done, and if it's data, makes sure that the plot will make the
temperature the height.</p>

<p> Example <a href="rsread.rb">: rsread.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
require "numru/dcl"
include NumRu 
file1 = File.open("./47646.y2d","r")
DCL::gropn(1)

while (line = file1.gets)  # loop until a file end

 # for Header
  if (line =~ /^#(\d{5})(\d{4})(\d{2})(\d{2})(\d{2})(\d{4})([\d]{4})$/)
    station, year, mon, day, hour, rtime, levels = $1, $2, $3, $4, $5, $6, $7
    DCL::grfrm
    DCL::grsvpt(0.10.90.10.9)
    DCL::grswnd(-70,30,0,35)
    DCL::grstrf
    DCL::usdaxs
    DCL::uxsttl("t","## {station} # {year}-# {mon}-# {day}# {hour} UTC",-1)
    DCL::uxsttl("b","Temperature [degC], ",0)
    DCL::uysttl("l","Geopotential Height [km], ",0)

 # for Data 
  elsif (line =~ /^(\d)(\d)([\d]{6})([AB])([\d -]{5})([AB ])([\d -]{5})([AB ])([\d -]{5})( [\d -]{5})([\d -]{5})$/)
    mjtype, mntype, pres, presf, gph, gphf, temp, tempf, dpd, winddir, wind = $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
    DCL::sgpmzu([temp.to_f/10.0], [gph.to_f/1000.0],5, 3, 0.02)
  else
    raise "invalid line: #{line}" " When which is not also, an error is thrown up "
  end

end

DCL::grcls

file1.close
</textarea>


<p> Please see <a href="http://www.ruby-lang.org/ja/20020314.html">here</a> and<a href="http://www.ruby-lang.org/ja/man/?cmd=view;name=%C0%B5%B5%AC%C9%BD%B8%BD"> here</a>
about a regular expression. The beginning seems complex and is
confused, from remembered one, gradually, it should be used. "\ d" but
a number and {5} are "5 time repeat". (), One which agrees with an
eaten part enters $1 $2 ... in turn from the front, so it's possible to
substitute that for a variable at the just after line.</p>

<p class="results">
<img src="rsread.png" height="341" width="456">
</p>



<h3> Extraction of a character data</h3>


<p> Only a specific variable in specific years will be taken out from
an upper file. The method such as puts, print or printf is used for
extraction of a text file. puts extracts a line of argument as a
minute, so a new paragraph enters certainly at the end. A new paragraph
is also controlled by itself at print and printf.</p>

<p> Example <a href="rsrw.rb">: rsrw.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
require "numru/dcl"
include NumRu

file1 = File.open("./47646.y2d","r")

file2 = File.open("./47646_200511","w") # "w" is a writing in mode.

while(line = file1.gets) #loop until a file end

 # for Header
  if (line =~ /^#(\d{5})(\d{4})(\d{2})(\d{2})(\d{2})(\d{4})([\d]{4})$/)

    station, year, mon, day, hour, rtime, levels = $1, $2, $3, $4, $5, $6, $7

    if (year.to_i == 2005 &amp;&amp; mon.to_i == 11)
      wflag = true
      file2.puts(line)
    else
      wflag = false
    end

 # for Data
  elsif (line =~ /^(\d)(\d)([\d]{6})([AB ])([\d -]{5})([AB ])(
[\d -]{5})([AB ])([\d -]{5})([\d -]{5})([\d -]{5})$/)
    mjtype, mntype, pres, presf, gph, gphf, temp, tempf, dpd, winddir, wind = $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
    if wflag
      file2.print(mjtype+mntype+pres+presf+gph+gphf+temp+tempf+"\n")
    end

  else
    raise "invalid line: # {line}"
  end

end

file2.close
file1.close
</textarea>


<p> The method of much is prepared about a text manipulation,
connection (+), division (split), comparison (&lt;=&gt; and
&amp;lt,&lt;=,&gt;,=&gt;,==), substitution (sub,gsub) and part taking,
(, [ ],),* Change (upcase,downcase) etc. of uppercase and lowercase
letters is enriched, so when using these, it can be processed freely
variously. You should refer to a <a href="http://www.ruby-lang.org/ja/man/index.cgi?cmd=view;name=String;em=String">manual</a> for more information. <a name="h2-5"></a></p><h2><a name="h2-5"> The reading and writing which is data in 5. Ruby-NetCDF</a></h2>

<p><a name="h2-5"> When a netcdf library is used, it's possible to read
and write a NetCDF file. I'll read a NetCDF file in irb in the
beginning. I have </a><a href="T.jan.nc">here</a> for a NetCDF file of a sample (the distribution of the temperature of 1 monthly average).</p><pre class="source">
require "numru/netcdf"
include NumRu
file1 = NetCDF.open("T.jan.nc") # open file and create NetCDF object
var_temp = file1.var("T") # open variable
temp = var_temp.get # get values of variable
p temp # show the values
p temp[0..4,10,true] # show the part of values
</pre><p> file1 is an object which corresponds to 1 NetCDF file, and
var_temp is an object which corresponds to 1 variable in file. The
price is being taken out from var_temp using the get method. (Because
it's the ordinary name, file1, var_temp, temp may use the favorite
name.) minimum, it's possible to read by only this procedure. When I
make the contents indicate, I find out that it's read as NArray.</p>

<h3> NetCDF data is read and a figure is drawn.</h3>

<p> It was read as NArray by an upper procedure, so it's possible to draw this using Ruby - DCL.</p>

<p> Example <a href="ncread.rb">: ncread.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
require "numru/netcdf"
require "numru/dcl"
include NumRu

file1 = NetCDF.open("T.jan.nc")

var_temp = file1.var("T")
temp = var_temp.get


var_level = file1.var("level")
level = var_level.get

file1.close

 p temp

DCL::gropn(1)

for k in 0..level.shape[0]-1 # repleat times of number of vertical level
  DCL::grfrm
  DCL::grstrn(10) # equidistant cylindrical projection
  DCL::grswnd (0.0,360.0,-90.0,90.0) # set lon and lat
  DCL::umpfit
  DCL::grstrf

  DCL::uelset("ltone",true)
  DCL::uetone(temp[true,-1..0,k]) # draw the temperature at kth level
                                  # data is located in the ary from the north so order is turned over by -1..0

  DCL::umpmap ("coast_world")     # draw lon and lat lines
  DCL::umpglb                     # draw map

  DCL::uxsttl("t","Temperature at # {level [k]}, hPa",0.0)

end

DCL::grcls
</textarea>

<p> A layer of plan is being drawn from the bottom by this example.
This example is the specific way to fill out dependent on the structure
of the NetCDF file for easiness, but when giving the form that I
inquire of an object a necessary matter, the thing which is being
expanded can make sure easily relatively that it can also correspond to
a different file. It's <a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/">GPhys to treat 1 variable of a NetCDF file (), a variable name which accompanies that and axis information as 1 object together.</a></p>


<p class="results">
<a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"><img src="ncread.png" height="341" width="456">
</a></p>


<h3><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> Practice problem</a></h3>

<p><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> When carrying out which height to get, I'll can choose.</a></p>
<p><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> Latitude and the high aspect are made about average east and west of east and west a look of the monthly average.</a></p>
<p><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> As years can be changed, when there are no files, I'll get by a ftp.</a></p>


<h3><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> A NetCDF file is made newly.</a></h3>

<p><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/">
A NetCDF file will be made next. First necessary things are dimensional
definition (def_dim) and definition of a variable (def_var). When it's
made enddef after this, a head part of a NetCDF file is made. And the
price will be written in using the put method. An optional argument
such as "start" and "end" is put on the in case of I'd like to write in
only the part of the variable (This is achieved using "hash".)</a></p>

<p><a href="http://www.gfd-dennou.org/arch/ruby/products/gphys/"> Example </a><a href="nccreate.rb">: nccreate.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
require "numru/netcdf"
include NumRu

file = NetCDF.create("test.nc") # Creation
nx, ny = 10, 5
file.def_dim("x",nx) #. Dimensional definition
file.def_dim("y",ny)
file.def_dim("t",0) # t is UNLIMITED
require "date"
file.put_att("history","created by #{$0} #{Date.today}") #setting of global attribute
x = file.def_var("x","sfloat",["x"]) # variable definision
y = file.def_var("y","sfloat",["y"])
t = file.def_var("t","sfloat",["t"])
v1 = file.def_var("v1","sfloat",["x","y"])
v1.put_att("long_name","test 1") # set a attribute
v1.put_att("units","1")
v2 = file.def_var("v2","sfloat",["x","y","t"])
v2.put_att("long_name","test 2")
v2.put_att("units","1")
file.enddef # end define mode
x.put(NArray.float(nx).indgen!) # put values
y.put(NArray.float(ny).indgen!)

z = NArray.float(nx,ny).indgen!*0.1
v1.put(z)
v1.put(NArray.float(nx).fill!(20), "start"=&gt; [02], "end"=&gt;[-1,2]) # put values from start to end
v2.put(z,"start"=&gt;[0,0,0], "end"=&gt; [-1,-1,0])
t.put(0, "index"=&gt;[0]) # put value at index
v2.put(-z,"start"=&gt; [0,0,1] and "end"=&gt; [-1,-1,1])
t.put(1, "index"=&gt;[1])

file.close
print `ncdump test.nc` # show the file created
</textarea>


<h3> Practice problem</h3>

<p> Do a test result of the class in Mr. 笑介 in NetCDF.</p>
<p></p>
<p> Eastern and western average east and west style of the monthly average is made a NetCDF file.</p>


<!--<h2>クラスを作ってみる </h2>-->

<h3> NetCDF is read and it's extracted by NetCDF.</h3>

<p> A NetCDF class will be expanded for itself to read NetCDF like an
upper practice problem, do some analysis processing and do the thing
such as extracting in NetCDF. A NetCDF file is read first and that's
extracted in a NetCDF file just as it is.</p>


<p> Example <a href="nccopy.rb">: nccopy.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
#/usr/bin/env ruby
require "numru/netcdf"
include NumRu

module NumRu
  class NetCDF
    def copy(outfilename)
      outfile = NetCDF.create(outfilename)

      self.each_dim {|d|
        outfile.def_dim(d.name, d.length) # Definition of the dimension
      }

      vlist = [] # variable list
      self.each_var {|v|
        vout = outfile.def_var(v.name, v.vartype, outfile.dims (v.dim_names))
        v.each_att{|a| a.copy (vout)} # Copy attributes
        vlist.push(vout) # add to the last of the list
      }

      self.each_att {|a| a.copy(outfile)} # copy global attributes

      outfile.enddef

      self.each_var{|v|
        vout = vlist.shift  # get the first variable from the list
        vout.put(v.get)     # copy the variable
        p vout.name
      }

      outfile.close
    end
  end
end

file = NetCDF.open("T.jan.nc")  # input file
file.copy("nccopy.nc")  # output file
file.close

# print `diff T.jan.nc nccopy.nc`</textarea>

<p> ITERETA such as each_dim, each_var, each_att is being used. When it
isn't accustomed to ITERETA, it's slightly complex, but it becomes
multi-purposed.</p>


<h3> Practice problem</h3>

<p> It's changed to the method everything is copied except for a designated variable.</p>
<p> Using this, eastern and western average east and west style of the monthly average is made a NetCDF file.</p>



<h3> Data analysis/analyses is by application.</h3>

<p> When increasing such script one after another, data
analysis/analyses can be done now easily. When advancing towards the
pin grid array format with the how to use volume I advanced <a href="http://ruby.gfd-dennou.org/tutorial/rakuraku/">a little and a coordinate by which the lost value is handled and a grads file is read </a>in the <a href="http://ruby.gfd-dennou.org/products/gphys/tutorial/">GPhys tutorial when class "GPhys" of scatter-ized physical quantity is handled, you'd be able to do higher how to use now.</a></p>

<a name="h2-6"></a>
<h2> 6. Fluid numerical value calculation.</h2>

<h3> Like Fortran (or C), numerical value calculation</h3>

<p> The numerical value calculation which was being done in Fortran can
also be written more easily in Ruby. The following example calculated
the state to which chaotic advection happens by Besnard convection.
Fluid does a complicated movement at the flowfield where all simple
periodic fluctuation is done.</p>

<p> Example <a href="benard.rb">: benard.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
#!/usr/bin/env ruby
require 'narray'
require "numru/dcl"
include NumRu
include NMath

n = 100
x = NArray.float(n).random!(0.1) + 0.02
y = NArray.float(n).random!(0.02) + 0.9
         # self.random!(max) generate ramdom value of 0 &lt;=x$lt;max

def uv(x,y,t)  # calcurate velocity at (x,y,z)
  a = 1.0 # amplitude of stedy wave
  k = 2.0 # wavenuber of eddy
  e = 0.2 # amplitude of eddy
  omega = PI*2
  u =  a*cos(PI*y)*sin(k*x) - e*cos(PI*y)*cos(k*x)*cos(omega*t)
  v = -a*sin(PI*y)*cos(k*x) + e*sin(PI*y)*sin(k*x)*cos(omega*t)
  return u,v
end

def advect(x,y,t,dt) # Runge-Kutta
  u1,v1 = uv(x, y, t)
  u2,v2 = uv(x+u1*dt/2.0, y+v1*dt/2.0, t+dt/2.0)
  u3,v3 = uv(x+u2*dt/2.0, y+v2*dt/2.0, t+dt/2.0)
  u4,v4 = uv(x+u3*dt, y+v3*dt, t+dt)

  x = x + (u1+u2*2+u3*2+u4)/6 * dt
  y = y + (v1+v2*2+v3*2+v4)/6 * dt
  t = t + dt

  return x,y,t
end

DCL::swiset('iwidth',512)      # set size of window
DCL::swiset('iheight',512)
if ARGV.index("-anim") then    # setting for animation
  DCL::swlset('lwait',false)
  DCL::swlset('lalt',true)
end
DCL::gropn(1)

t = 0.0
dt = 0.05
for i in 1..1000
  x,y,t = advect(x,y,t,dt)

  x[ x < 0.0 ] = x[ x < 0.0 ] + PI       # for Cyclic
  x[ x > PI ]  = x[ x > PI ]  - PI

  if ( ARGV.index("-anim") || i%5 == 0 )
    DCL::grfrm
    DCL::grswnd( 0.0, PI, 0.0, 1.0 )
    DCL::grsvpt( 0.1, 0.9, 0.2, 0.7 )
    DCL::grstrf
    DCL::usdaxs

    DCL::sgspmi(22)                      # setting of color, and width of points
    DCL::sgpmu( x, y )                   # draw point at (x,y)
  end
end

DCL::grcls
</textarea>

<p class="results">
<img src="Benard.png" height="341" width="456">
</p>




<h3> A class is made, and, numerical value calculation</h3>

<p> An upper example used the algorithm written in Fortran just as it
is and rewrote in Ruby, but I'll do that I made a class this time and
resembled. The next example is a numerical value calculation experiment
of a soliton. I make a class newly and name Field. A coordinate system
is defined by initialize, defaults are established and a definition of
spatial differentiation, a KdV equation and the method of the time
integration are made.</p>

<p> Example <a href="kdv.rb">: kdv.rb</a></p>

<textarea cols="80" rows="20" wrap="hard" class="source">
#!/usr/bin/env ruby
#
# solving the KdV. equation and vizualization of the solution(animation)
#
# * configuration
#   equation ; du/dt + u du/dx + nu d^3u/dx^3
#   region   ; x = [0,pi] t=[0,TN]
#   b.c.     ; periodic i.e. u(xmin,t) = u(xmax,t)
#   i.c.     ; u(x,0) = cos x etc. 
# 
# *diffencce
#    RKG (4th order) for time
#    central dif for space
# 
# *experiment
#   fix nu and TN, and change initial condition
#
# *recomented parameter
#   e.g. JMAX=100, nu=0.01, DT=1e-4  => you have to modify them
# 
# 00/01/17 Taguchi 
# 00/11/14 convert to f90
# 03/02/23 convert to ruby
#----------------------------------------------------------------------#
require 'narray'
require "numru/dcl"

include NumRu
include NMath

class NArray # add method to NArray Class
  def cshift(n) # corresponding to cshift of Fortran90
    #if(n > x.size) ...
    y = self.dup
    y[n..-1] = self[0..-1-n]
    y[0..n-1] = self[-n..-1]
    return y
  end
end

class Field
  def initialize(x,u,nu)
    @x = x
    @u = u
    @nu = nu
    @dx = @x[1]-@x[0]
  end

  def d_dx(u) # differntial(centered differnce)
    (u.cshift(1)-u.cshift(-1))/(2*@dx)
  end

  def d3_dx3(u) # differential of 3rd order
    (u.cshift(2)-2*u.cshift(1)+2*u.cshift(-1)-u.cshift(-2))/(2*@dx**3)
  end

  def kdv(u) # KdV quation
    -u * d_dx(u) - @nu * d3_dx3(u)
  end

  def integ(dt) # time integration(Runge-Kutta of 4th order)
    du1 = kdv(@u)
    du2 = kdv(@u+du1*dt/2)
    du3 = kdv(@u+du2*dt/2)
    du4 = kdv(@u+du3*dt)
    @u = @u + (du1+du2*2+du3*2+du4)/6 * dt
  end

  def x
    return @x
  end

  def u
    return @u
  end
end


if ARGV.index("-anim") then
  DCL::swlset('lwait',false)
  DCL::swlset('lalt',true)
end

# set the initial condition

jmax = 100
xmin = 0.0
xmax = PI
dt = 0.0002

dx = (xmax-xmin)/jmax
x = NArray.sfloat(jmax).indgen!*dx + xmin

nu = 0.005
u1 = 4.0
d1 = sqrt(12.0*nu/u1)
u2 = 1.0
d2 = sqrt(12.0*nu/u2)
u = u1/( cosh( (x-PI/2)/d1 ) )**2 + u2/( cosh( (x-PI/4)/d2 ) )**2

a = Field.new(x,u,nu)

DCL::gropn(1)
loop do
  DCL::grfrm
  DCL::grswnd(xmin,xmax,0.0,5.0)
  DCL::usgrph(a.x,a.u)
  50.times do a.integ(dt) end
end
DCL::grcls
</textarea>

<p class="results">
<img src="kdv.png" height="341" width="456">
</p>



<h3> Practice problem</h3>

<p> I change an early stage corrugation variously and experiment. The
method to which a corrugation is given is defined newly in the Field
class, and makes sure that it'll be changed from outside.</p>

<hr> <a href="http://ruby.gfd-dennou.org/">Geophysical fluid computer club</a> /<a href="http://ruby.gfd-dennou.org/index-j.htm">Computer Ruby</a> /<a href="http://ruby.gfd-dennou.org/tutorial/">Tutorial</a> /Basic course<hr>
<p><img src="meladd.gif"></p>
<p> Copyright (C)  2003-2006 GFD Dennou Club. All Rights Reserved.</p><p>

<!--<p>% irb -r ???.rb としておけばスクリプトを読んでからirb</p>-->
</p>
</body></html>
